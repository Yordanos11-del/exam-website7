<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results - STEMExamPro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <i class="fas fa-atom"></i>
                <span>STEMExamPro</span>
            </div>
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> Home</a>
                <a href="exam.html"><i class="fas fa-play-circle"></i> Exam</a>
                <a href="results.html" class="active"><i class="fas fa-chart-bar"></i> Results</a>
                <a href="admin.html"><i class="fas fa-cog"></i> Admin</a>
            </div>
        </div>
    </nav>

    <div class="results-container">
        <div class="score-display">
            <div class="score-circle">
                <h2 id="score-value">0</h2>
                <p>Score</p>
            </div>
            <h1>Exam Completed!</h1>
            <p id="score-text">You scored <span id="percentage">0%</span> (<span id="score-value-text">0</span>/<span id="total-questions">0</span>)</p>
            
            <div class="result-actions" style="margin-top: 30px;">
                <button class="btn-control" onclick="window.location.href='exam.html'">
                    <i class="fas fa-redo"></i> Take Another Test
                </button>
                <button class="btn-control" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Results
                </button>
                <button class="btn-control" onclick="shareResults()">
                    <i class="fas fa-share-alt"></i> Share Results
                </button>
            </div>
        </div>
        
        <div class="result-details">
            <h3><i class="fas fa-info-circle"></i> Exam Details</h3>
            <div id="result-details">
                <!-- Details will be loaded by JavaScript -->
            </div>
        </div>
        
        <div class="question-review-section">
            <h3><i class="fas fa-list-ol"></i> Question Review</h3>
            <div id="question-review">
                <!-- Questions will be loaded by JavaScript -->
            </div>
        </div>
        
        <div class="performance-analysis" style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h3><i class="fas fa-chart-pie"></i> Performance Analysis</h3>
            <div id="performance-chart">
                <!-- Chart will be generated by JavaScript -->
            </div>
            <div class="recommendations" id="recommendations" style="margin-top: 20px;">
                <!-- Recommendations will be added by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        function shareResults() {
            const results = JSON.parse(localStorage.getItem('lastExamResults'));
            if (!results) return;
            
            const text = `I scored ${results.score}/${results.total} (${results.percentage}%) in ${results.subject} on STEMExamPro!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Exam Results',
                    text: text,
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(text)
                    .then(() => alert('Results copied to clipboard!'))
                    .catch(() => alert('Could not share results.'));
            }
        }
        
        function generatePerformanceChart() {
            const results = JSON.parse(localStorage.getItem('lastExamResults'));
            if (!results) return;
            
            // Group by topic
            const topicPerformance = {};
            results.questions.forEach((question, index) => {
                const topic = question.topic;
                const userAnswer = results.answers[question.id];
                const isCorrect = userAnswer === question.correctAnswer;
                
                if (!topicPerformance[topic]) {
                    topicPerformance[topic] = { correct: 0, total: 0 };
                }
                
                topicPerformance[topic].total++;
                if (isCorrect) {
                    topicPerformance[topic].correct++;
                }
            });
            
            // Generate chart HTML
            const chartContainer = document.getElementById('performance-chart');
            if (chartContainer) {
                let html = '<div style="display: grid; gap: 15px; margin-top: 20px;">';
                
                Object.entries(topicPerformance).forEach(([topic, stats]) => {
                    const percentage = (stats.correct / stats.total * 100).toFixed(1);
                    const barWidth = Math.min(percentage, 100);
                    
                    html += `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>${topic}</span>
                                <span>${stats.correct}/${stats.total} (${percentage}%)</span>
                            </div>
                            <div style="height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                                <div style="width: ${barWidth}%; height: 100%; background: ${percentage >= 70 ? '#4CAF50' : percentage >= 50 ? '#ffa726' : '#ff6b6b'};"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                chartContainer.innerHTML = html;
            }
            
            // Generate recommendations
            const recommendations = document.getElementById('recommendations');
            if (recommendations) {
                let weakTopics = [];
                Object.entries(topicPerformance).forEach(([topic, stats]) => {
                    const percentage = (stats.correct / stats.total * 100);
                    if (percentage < 60) {
                        weakTopics.push(topic);
                    }
                });
                
                if (weakTopics.length > 0) {
                    recommendations.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #ff6b6b;">
                            <h4 style="color: #ff6b6b; margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle"></i> Areas for Improvement
                            </h4>
                            <p>Focus on these topics: <strong>${weakTopics.join(', ')}</strong></p>
                            <p>Practice more questions in these areas to improve your score.</p>
                        </div>
                    `;
                } else {
                    recommendations.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #4CAF50;">
                            <h4 style="color: #4CAF50; margin-bottom: 10px;">
                                <i class="fas fa-trophy"></i> Excellent Performance!
                            </h4>
                            <p>You performed well across all topics. Keep up the good work!</p>
                        </div>
                    `;
                }
            }
        }
        
        // Initialize results page
        document.addEventListener('DOMContentLoaded', function() {
            // Display results will be called from script.js
            // Also generate performance chart
            setTimeout(generatePerformanceChart, 100);
        });
    </script>
    
    <script src="questions.js"></script>
    <script src="script.js"></script>
</body>
</html>