// Exam State Management
class ExamManager {
    constructor() {
        this.currentExam = null;
        this.currentQuestionIndex = 0;
        this.userAnswers = {};
        this.score = 0;
        this.timeLeft = 1800; // 30 minutes in seconds
        this.timerInterval = null;
        this.questions = [];
    }
    
    initializeExam(subject, questionCount = 10) {
        this.currentExam = {
            subject: subject,
            questionCount: questionCount,
            startTime: new Date(),
            questions: getQuestions(subject, questionCount)
        };
        
        this.questions = this.currentExam.questions;
        this.currentQuestionIndex = 0;
        this.userAnswers = {};
        this.score = 0;
        this.timeLeft = 30 * 60; // Reset to 30 minutes
        
        this.saveExamState();
        this.updateDisplay();
        this.startTimer();
    }
    
    startTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }
        
        this.timerInterval = setInterval(() => {
            this.timeLeft--;
            this.updateTimerDisplay();
            
            if (this.timeLeft <= 0) {
                this.submitExam();
            }
        }, 1000);
    }
    
    updateTimerDisplay() {
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            const minutes = Math.floor(this.timeLeft / 60);
            const seconds = this.timeLeft % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running low
            if (this.timeLeft < 300) { // Less than 5 minutes
                timerElement.style.background = 'linear-gradient(45deg, #ff6b6b, #ffa726)';
            }
        }
    }
    
    selectAnswer(optionIndex) {
        const questionId = this.questions[this.currentQuestionIndex].id;
        this.userAnswers[questionId] = optionIndex;
        this.saveExamState();
        this.updateDisplay();
    }
    
    navigateToQuestion(index) {
        if (index >= 0 && index < this.questions.length) {
            this.currentQuestionIndex = index;
            this.saveExamState();
            this.updateDisplay();
        }
    }
    
    nextQuestion() {
        if (this.currentQuestionIndex < this.questions.length - 1) {
            this.navigateToQuestion(this.currentQuestionIndex + 1);
        }
    }
    
    previousQuestion() {
        if (this.currentQuestionIndex > 0) {
            this.navigateToQuestion(this.currentQuestionIndex - 1);
        }
    }
    
    calculateScore() {
        let score = 0;
        this.questions.forEach(question => {
            const userAnswer = this.userAnswers[question.id];
            if (userAnswer !== undefined && userAnswer === question.correctAnswer) {
                score++;
            }
        });
        this.score = score;
        return score;
    }
    
    submitExam() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }
        
        this.calculateScore();
        
        // Save results to localStorage
        const results = {
            subject: this.currentExam.subject,
            score: this.score,
            total: this.questions.length,
            percentage: (this.score / this.questions.length * 100).toFixed(1),
            answers: this.userAnswers,
            questions: this.questions,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('lastExamResults', JSON.stringify(results));
        
        // Redirect to results page
        window.location.href = 'results.html';
    }
    
    updateDisplay() {
        // Update question counter
        const counterElement = document.getElementById('question-counter');
        if (counterElement) {
            counterElement.textContent = `${this.currentQuestionIndex + 1}/${this.questions.length}`;
        }
        
        // Update subject display
        const subjectElement = document.getElementById('current-subject');
        if (subjectElement) {
            const subjectNames = {
                mathematics: 'Mathematics',
                physics: 'Physics',
                chemistry: 'Chemistry'
            };
            subjectElement.textContent = subjectNames[this.currentExam?.subject] || 'General';
        }
        
        // Update score display
        const scoreElement = document.getElementById('current-score');
        if (scoreElement) {
            scoreElement.textContent = this.score;
        }
        
        // Update question display
        this.displayCurrentQuestion();
        
        // Update progress
        this.updateProgressBar();
        
        // Update navigation buttons
        this.updateNavigationButtons();
    }
    
    displayCurrentQuestion() {
        if (!this.questions || this.questions.length === 0) return;
        
        const question = this.questions[this.currentQuestionIndex];
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        
        if (questionTextElement) {
            questionTextElement.innerHTML = question.question;
        }
        
        if (optionsContainer) {
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                
                // Check if this option was selected
                const questionId = question.id;
                const isSelected = this.userAnswers[questionId] === index;
                if (isSelected) {
                    optionElement.classList.add('selected');
                }
                
                optionElement.innerHTML = `
                    <div class="option-label">${String.fromCharCode(65 + index)}</div>
                    <div class="option-text">${option}</div>
                `;
                
                optionElement.addEventListener('click', () => {
                    this.selectAnswer(index);
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([optionsContainer]);
            }
        }
        
        // Re-render MathJax for question
        if (window.MathJax && questionTextElement) {
            MathJax.typesetPromise([questionTextElement]);
        }
    }
    
    updateProgressBar() {
        const progressFill = document.getElementById('progress-fill');
        const questionDots = document.getElementById('question-dots');
        
        if (progressFill) {
            const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
            progressFill.style.width = `${progress}%`;
        }
        
        if (questionDots) {
            questionDots.innerHTML = '';
            this.questions.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'question-dot';
                if (index === this.currentQuestionIndex) {
                    dot.classList.add('active');
                }
                
                // Check if answered
                const questionId = this.questions[index].id;
                if (this.userAnswers[questionId] !== undefined) {
                    dot.classList.add('answered');
                }
                
                dot.addEventListener('click', () => {
                    this.navigateToQuestion(index);
                });
                
                questionDots.appendChild(dot);
            });
        }
    }
    
    updateNavigationButtons() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        
        if (prevBtn) {
            prevBtn.disabled = this.currentQuestionIndex === 0;
        }
        
        if (nextBtn) {
            const isLastQuestion = this.currentQuestionIndex === this.questions.length - 1;
            nextBtn.style.display = isLastQuestion ? 'none' : 'flex';
        }
        
        if (submitBtn) {
            const isLastQuestion = this.currentQuestionIndex === this.questions.length - 1;
            submitBtn.style.display = isLastQuestion ? 'flex' : 'none';
            
            // Add submit functionality
            submitBtn.onclick = () => this.submitExam();
        }
    }
    
    saveExamState() {
        const state = {
            currentExam: this.currentExam,
            currentQuestionIndex: this.currentQuestionIndex,
            userAnswers: this.userAnswers,
            score: this.score,
            timeLeft: this.timeLeft,
            questions: this.questions
        };
        
        try {
            localStorage.setItem('examState', JSON.stringify(state));
        } catch (error) {
            console.error('Error saving exam state:', error);
        }
    }
    
    loadExamState() {
        try {
            const saved = localStorage.getItem('examState');
            if (saved) {
                const state = JSON.parse(saved);
                
                this.currentExam = state.currentExam;
                this.currentQuestionIndex = state.currentQuestionIndex;
                this.userAnswers = state.userAnswers;
                this.score = state.score;
                this.timeLeft = state.timeLeft;
                this.questions = state.questions || [];
                
                return true;
            }
        } catch (error) {
            console.error('Error loading exam state:', error);
        }
        return false;
    }
}

// Initialize global exam manager
const examManager = new ExamManager();

// Function to initialize exam from homepage
function initializeExam(subject) {
    examManager.initializeExam(subject);
    
    // Set up event listeners for navigation
    document.getElementById('prev-btn')?.addEventListener('click', () => {
        examManager.previousQuestion();
    });
    
    document.getElementById('next-btn')?.addEventListener('click', () => {
        examManager.nextQuestion();
    });
    
    document.getElementById('submit-btn')?.addEventListener('click', () => {
        examManager.submitExam();
    });
}

// Function to show explanation
function showExplanation(question) {
    const modal = document.getElementById('explanation-modal');
    const content = document.getElementById('explanation-content');
    
    if (modal && content && question) {
        content.innerHTML = `
            <div class="explanation">
                <p><strong>Correct Answer:</strong> ${question.options[question.correctAnswer]}</p>
                <p><strong>Explanation:</strong> ${question.explanation}</p>
                <p><strong>Topic:</strong> ${question.topic}</p>
                <p><strong>Difficulty:</strong> ${question.difficulty}</p>
            </div>
        `;
        modal.style.display = 'block';
        
        // Re-render MathJax in modal
        if (window.MathJax) {
            MathJax.typesetPromise([content]);
        }
    }
}

// Function to close modal
function closeModal() {
    const modal = document.getElementById('explanation-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Admin Panel Functions
function initializeAdminPanel() {
    const form = document.getElementById('add-question-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('question-subject').value;
            const question = document.getElementById('question-text-input').value;
            const options = Array.from(document.querySelectorAll('.option-input input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');
            
            const correctAnswer = parseInt(document.getElementById('correct-answer').value);
            const explanation = document.getElementById('explanation-text').value;
            const difficulty = document.getElementById('question-difficulty').value;
            const topic = document.getElementById('question-topic').value;
            
            if (options.length < 2) {
                alert('Please add at least 2 options');
                return;
            }
            
            const questionData = {
                question: question,
                options: options,
                correctAnswer: correctAnswer,
                explanation: explanation,
                difficulty: difficulty,
                topic: topic
            };
            
            const newQuestion = addQuestion(subject, questionData);
            
            // Reset form
            form.reset();
            clearOptions();
            addOptionInput();
            addOptionInput();
            
            alert(`Question added successfully! ID: ${newQuestion.id}`);
        });
    }
    
    // Initialize option inputs
    clearOptions();
    addOptionInput();
    addOptionInput();
}

function addOptionInput() {
    const container = document.getElementById('options-container-input');
    if (!container) return;
    
    const index = container.children.length;
    const div = document.createElement('div');
    div.className = 'option-input';
    div.innerHTML = `
        <input type="text" placeholder="Option ${String.fromCharCode(65 + index)}" required>
        <button type="button" class="remove-option" onclick="removeOptionInput(this)">Ã—</button>
    `;
    container.appendChild(div);
}

function removeOptionInput(button) {
    const container = document.getElementById('options-container-input');
    if (container && container.children.length > 2) {
        button.parentElement.remove();
        updateOptionLabels();
    }
}

function clearOptions() {
    const container = document.getElementById('options-container-input');
    if (container) {
        container.innerHTML = '';
    }
}

function updateOptionLabels() {
    const inputs = document.querySelectorAll('.option-input input');
    inputs.forEach((input, index) => {
        input.placeholder = `Option ${String.fromCharCode(65 + index)}`;
    });
    
    // Update correct answer dropdown
    const correctAnswerSelect = document.getElementById('correct-answer');
    if (correctAnswerSelect) {
        correctAnswerSelect.innerHTML = '';
        inputs.forEach((_, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Option ${String.fromCharCode(65 + index)}`;
            correctAnswerSelect.appendChild(option);
        });
    }
}

// Results Page Functions
function displayResults() {
    try {
        const results = JSON.parse(localStorage.getItem('lastExamResults'));
        if (!results) {
            window.location.href = 'index.html';
            return;
        }
        
        // Display score
        document.getElementById('score-value').textContent = results.score;
        document.getElementById('total-questions').textContent = results.total;
        document.getElementById('percentage').textContent = `${results.percentage}%`;
        
        // Display result details
        const resultDetails = document.getElementById('result-details');
        if (resultDetails) {
            resultDetails.innerHTML = `
                <div class="result-item">
                    <span>Subject:</span>
                    <span>${results.subject.charAt(0).toUpperCase() + results.subject.slice(1)}</span>
                </div>
                <div class="result-item">
                    <span>Date:</span>
                    <span>${new Date(results.timestamp).toLocaleDateString()}</span>
                </div>
                <div class="result-item">
                    <span>Time:</span>
                    <span>${new Date(results.timestamp).toLocaleTimeString()}</span>
                </div>
            `;
        }
        
        // Display question review
        const reviewContainer = document.getElementById('question-review');
        if (reviewContainer) {
            reviewContainer.innerHTML = '';
            
            results.questions.forEach((question, index) => {
                const userAnswer = results.answers[question.id];
                const isCorrect = userAnswer === question.correctAnswer;
                
                const reviewQuestion = document.createElement('div');
                reviewQuestion.className = `review-question ${isCorrect ? 'correct' : 'incorrect'}`;
                reviewQuestion.innerHTML = `
                    <div class="question-review">
                        <p><strong>Question ${index + 1}:</strong> ${question.question}</p>
                        <p class="correct-answer">Correct Answer: ${question.options[question.correctAnswer]}</p>
                        ${userAnswer !== undefined ? 
                            `<p class="your-answer">Your Answer: ${question.options[userAnswer]}</p>` : 
                            `<p class="your-answer">Your Answer: Not attempted</p>`
                        }
                        <p><strong>Explanation:</strong> ${question.explanation}</p>
                        <p><strong>Topic:</strong> ${question.topic} | <strong>Difficulty:</strong> ${question.difficulty}</p>
                    </div>
                `;
                
                reviewContainer.appendChild(reviewQuestion);
            });
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([reviewContainer]);
            }
        }
    } catch (error) {
        console.error('Error displaying results:', error);
        window.location.href = 'index.html';
    }
}

// Initialize based on current page
document.addEventListener('DOMContentLoaded', function() {
    const currentPage = window.location.pathname;
    
    if (currentPage.includes('exam.html')) {
        // Check for saved exam state
        if (examManager.loadExamState()) {
            examManager.updateDisplay();
            examManager.startTimer();
            
            // Set up event listeners
            document.getElementById('prev-btn')?.addEventListener('click', () => {
                examManager.previousQuestion();
            });
            
            document.getElementById('next-btn')?.addEventListener('click', () => {
                examManager.nextQuestion();
            });
            
            document.getElementById('submit-btn')?.addEventListener('click', () => {
                examManager.submitExam();
            });
        } else {
            // Redirect to home if no exam state
            window.location.href = 'index.html';
        }
    } else if (currentPage.includes('admin.html')) {
        initializeAdminPanel();
    } else if (currentPage.includes('results.html')) {
        displayResults();
    }
    
    // Add MathJax configuration
    if (window.MathJax) {
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    }
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('explanation-modal');
    if (event.target === modal) {
        closeModal();
    }
};

// Keyboard shortcuts for exam navigation
document.addEventListener('keydown', function(event) {
    if (window.location.pathname.includes('exam.html')) {
        switch(event.key) {
            case 'ArrowLeft':
                examManager.previousQuestion();
                break;
            case 'ArrowRight':
                examManager.nextQuestion();
                break;
            case '1':
            case '2':
            case '3':
            case '4':
                const optionIndex = parseInt(event.key) - 1;
                if (optionIndex >= 0 && optionIndex < 4) {
                    examManager.selectAnswer(optionIndex);
                }
                break;
            case 'Enter':
                if (examManager.currentQuestionIndex === examManager.questions.length - 1) {
                    examManager.submitExam();
                } else {
                    examManager.nextQuestion();
                }
                break;
        }
    }
});